<!DOCTYPE html>  <html> <head>   <title>template.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="ajs.html">                 ajs.js               </a>                                           <a class="source" href="cache.html">                 cache.js               </a>                                           <a class="source" href="compiler.html">                 compiler.js               </a>                                           <a class="source" href="grammar.html">                 grammar.js               </a>                                           <a class="source" href="lexer.html">                 lexer.js               </a>                                           <a class="source" href="parser.html">                 parser.js               </a>                                           <a class="source" href="template.html">                 template.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               template.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="index.html">&laquo; Back to Index</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">path</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">util</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">EventEmitter</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
  <span class="p">,</span> <span class="nx">Compiler</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./compiler&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Cache</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./cache&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>AJS Template</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Here compile the AJS source and wrap it in a function that gives it a new
VM to run in on each call.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Template</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Compiler</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">opts</span><span class="p">).</span><span class="nx">compile</span><span class="p">();</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">locals</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">VM</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">opts</span><span class="p">).</span><span class="nx">render</span><span class="p">(</span><span class="nx">locals</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>AJS Virtual Machine</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>In the VM we execute the compiled AJS code in a context that captures
and buffers output until callbacks return and we're ready to flush</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">VM</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">VM</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">filename</span>     <span class="o">=</span> <span class="nx">resolveFilename</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">dirname</span>      <span class="o">=</span> <span class="nx">resolveDirname</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">line</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">error</span>        <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">_function</span>    <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_locals</span>      <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_depth</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbDepth</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbs</span>         <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_inCb</span>        <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span>    <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span>      <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">VM</span><span class="p">,</span> <span class="nx">EventEmitter</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We delay the actual execution of the template function by a tick
to give us time to bind to the <code>data</code>, <code>error</code> and <code>end</code> events.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">locals</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_locals</span>     <span class="o">=</span> <span class="nx">locals</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_execute</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We kick off the VM by calling the compiled template function,
passing it our own vm context (for writes and callback handling),
as well as the locals passed in for the current request.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_execute</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_depth</span><span class="o">++</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_function</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_vmContext</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_runLocals</span><span class="p">());</span>  
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>When you call <code>include</code> in a template, we use <code>Loader</code> to find
the appropriate template (using a cached copy if available),
pass it the context you provide, and execute it under this VM.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_include</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">locals</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dirname</span><span class="p">,</span> <span class="nx">request</span> <span class="o">+</span> <span class="s1">&#39;.ajs&#39;</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">filename</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;self include&#39;</span><span class="p">);</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">loadInclude</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;ENOENT&#39;</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;EBADF&#39;</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find include: &#39;&quot;</span> <span class="o">+</span> <span class="nx">request</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">includeLocals</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_runLocals</span><span class="p">(),</span> <span class="nx">locals</span> <span class="o">||</span> <span class="p">{});</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_depth</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">template</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_vmContext</span><span class="p">(),</span> <span class="nx">includeLocals</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">locals</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">template</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">Cache</span><span class="p">.</span><span class="nx">_store</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span>
      <span class="nx">template</span> <span class="o">=</span> <span class="nx">Cache</span><span class="p">.</span><span class="nx">_store</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Compiler</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">opts</span><span class="p">).</span><span class="nx">compile</span><span class="p">();</span>
  
  <span class="kd">var</span> <span class="nx">renderLocals</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_runLocals</span><span class="p">(),</span> <span class="nx">locals</span> <span class="o">||</span> <span class="p">{});</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">_depth</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">template</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_vmContext</span><span class="p">(),</span> <span class="nx">renderLocals</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This is where the magic&trade; happens. The compiler wraps any arguments
that look like callbacks with this function, enabling us to keep track of when
a callback returns and when its completed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_wrapCb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">func</span> <span class="o">!=</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
  
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_inCb</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;nested callback&#39;</span><span class="p">);</span>
    
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">,</span> <span class="nx">cb</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span> <span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbDepth</span><span class="o">++</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">_cbStart</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">_cbEnd</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_cbStart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbDepth</span><span class="o">--</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">done</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_inCb</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_cbEnd</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">done</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_inCb</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_write</span><span class="p">();</span>  
<span class="p">}</span>

<span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_write</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">include</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>We're not waiting on any callbacks, so write directly to the main buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cbDepth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>If we're currently writing <em>inside</em> a callback, we make sure to write
to its own buffer. Otherwise we write to the cb buffer so we stay in order.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_inCb</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_inCb</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Each time we write, check to see if any callbacks have been completed.
If so, we can dump its buffer into the main buffer and continue until
we hit the next incomplete callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">done</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">cb</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">cb</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">cb</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_flush</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cbBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We don't want to overload the socket with too many writes, so we only
flush on two occasions: (1) when we start waiting on a callback, and
(2) when the template has finished rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isComplete</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_flush</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_flush</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If there's anything in the buffer, emit a <code>data</code> event
with the contents of the buffer as a <code>String</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_buffer</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If we're done executing, emit an <code>end</code> event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isComplete</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Our compiled AJS is instrumented with calls so we can keep track of
corresponding line numbers in the original AJS source.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_line</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>When an error occurs during template execution, we handle it here so
we can add additional information and emit an <code>error</code> event.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_flush</span><span class="p">();</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">filename</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">filename</span><span class="p">;</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39; at (&#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>All templates call <code>_end()</code> when they're finished. Since some templates
are actually nested <code>include</code>s, we use <code>_depth</code> to let us know when we're actually done. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_end</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_depth</span><span class="o">--</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_write</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We know we're done when the parent template is complete and all callbacks have returned.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isComplete</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cbDepth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Here we build the actual VM context that's passed to the compiled AJS code.
The calls to these functions are added automatically by the compiler.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_vmContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_vmContext_</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_vmContext_</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">_vmContext_</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">_wrapCb</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">out</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">_write</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">ln</span><span class="o">:</span>    <span class="k">this</span><span class="p">.</span><span class="nx">_line</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">end</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">_end</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">err</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">_error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">inc</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">_include</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">ren</span><span class="o">:</span>   <span class="k">this</span><span class="p">.</span><span class="nx">_render</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">flush</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_flush</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">esc</span><span class="o">:</span>   <span class="nx">escape</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_vmContext_</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Here we extend the context passed into the template by you,
adding a few helpful global properties along the way.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VM</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_runLocals</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_runLocals_</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_runLocals_</span><span class="p">;</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">_runLocals_</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">_locals</span><span class="p">);</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">_runLocals_</span><span class="p">.</span><span class="nx">__filename</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">filename</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_runLocals_</span><span class="p">.</span><span class="nx">__dirname</span>     <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dirname</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_runLocals_</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">filenameCache</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">function</span> <span class="nx">resolveFilename</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">cached</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">cached</span> <span class="o">=</span> <span class="nx">filenameCache</span><span class="p">[</span><span class="nx">filename</span><span class="p">])</span>
    <span class="k">return</span> <span class="nx">cached</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">return</span> <span class="nx">filenameCache</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="nx">filename</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">dirnameCache</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">function</span> <span class="nx">resolveDirname</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">cached</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">cached</span> <span class="o">=</span> <span class="nx">dirnameCache</span><span class="p">[</span><span class="nx">filename</span><span class="p">])</span>
    <span class="k">return</span> <span class="nx">cached</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">return</span> <span class="nx">dirnameCache</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>When we include templates from a running VM, we specificy the <code>bare</code> option
so the compiler doesn't wrap the template in a new VM.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">loadInclude</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">opts</span><span class="p">.</span><span class="nx">bare</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  
  <span class="kd">var</span> <span class="nx">template</span>
    <span class="p">,</span> <span class="nx">cache</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cache</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cache</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cache</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cached</span> <span class="o">=</span> <span class="nx">Cache</span><span class="p">.</span><span class="nx">getSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">)))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">cached</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span> <span class="o">=</span> <span class="nx">filename</span><span class="p">;</span>
      <span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Compiler</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="nx">opts</span><span class="p">).</span><span class="nx">compile</span><span class="p">();</span>
      <span class="nx">Cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">template</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">template</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;In &quot;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
    <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;(?!\w+;)/g</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
  <span class="nx">props</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="nx">target</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 